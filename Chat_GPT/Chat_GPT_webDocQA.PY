import streamlit as st
from dotenv import load_dotenv
import os

from langchain.document_loaders import TextLoader
from langchain.text_splitter import CharacterTextSplitter
from langchain.vectorstores import FAISS
from langchain.embeddings import OpenAIEmbeddings
from langchain.llms import OpenAI

# ğŸ” í™˜ê²½ ë³€ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")

# ğŸ§  GPT, ì„ë² ë”© ëª¨ë¸ ì¤€ë¹„
llm = OpenAI(openai_api_key=api_key)
embedding = OpenAIEmbeddings(openai_api_key=api_key)

# ğŸ“„ ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
loader = TextLoader("data/sample.txt", encoding="utf-8")
documents = loader.load()

# ğŸ“‘ ë¬¸ì„œ ë¶„í• 
text_splitter = CharacterTextSplitter(chunk_size=300, chunk_overlap=50)
docs = text_splitter.split_documents(documents)

# ğŸ§  ë²¡í„° ì„ë² ë”© ì €ì¥
db = FAISS.from_documents(docs, embedding)
retriever = db.as_retriever()

# ğŸŒ Streamlit UI ì‹œì‘
st.set_page_config(page_title="ğŸ“„ ë¬¸ì„œ ê¸°ë°˜ GPT", page_icon="ğŸ“˜")
st.title("ğŸ“„ ì„±ì£¼ì˜ ë¬¸ì„œ ê¸°ë°˜ GPT ì–´ì‹œìŠ¤í„´íŠ¸")
st.markdown("ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ GPTê°€ ëŒ€ë‹µí•´ë“œë¦½ë‹ˆë‹¤!")

# ğŸ¤” ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥
query = st.text_input("ë¬¸ì„œ ê¸°ë°˜ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” ğŸ“")

# âœ… ë²„íŠ¼ í´ë¦­ ì‹œ ì‘ë‹µ ì‹¤í–‰
if st.button("ì§ˆë¬¸í•˜ê¸°"):
    if query:
        with st.spinner("ë¬¸ì„œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...ğŸ“š"):
            # ë¬¸ì„œ ê¸°ë°˜ ê²€ìƒ‰
            docs = retriever.get_relevant_documents(query)
            context = "\n".join([doc.page_content for doc in docs]) if docs else "ê´€ë ¨ ë¬¸ì„œ ì—†ìŒ."

            # í”„ë¡¬í”„íŠ¸ êµ¬ì„±
            prompt = f"""
            ë„ˆëŠ” ë¬¸ì„œ ê¸°ë°˜ AIì•¼.
            ì•„ë˜ ë¬¸ì„œë¥¼ ì°¸ê³ í•´ì„œ ì§ˆë¬¸ì— ìµœëŒ€í•œ ì •í™•í•˜ê²Œ ë‹µë³€í•´ì¤˜.

            [ë¬¸ì„œ]
            {context}

            [ì§ˆë¬¸]
            {query}

            [ë‹µë³€]
            """

            # GPT ì‘ë‹µ ìƒì„±
            response = llm(prompt)

        st.success("âœ… ë¬¸ì„œ ê¸°ë°˜ GPTì˜ ë‹µë³€:")
        st.write(response)
    else:
        st.warning("ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!")

# ì‹¤í–‰ ëª…ë ¹ì–´ : streamlit run Chat_GPT_webaDocQA.py